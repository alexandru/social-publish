############################
# Test Dockerfile
# 
# Runs tests in an environment that matches production:
# - Uses jlink-based minimal JRE (same as production)
# - Includes ImageMagick with all required delegates
# - Same Alpine Linux base as production
############################

############################
# Base stage (Dependency Resolution)
############################
FROM gradle:8.11-jdk21 AS base
WORKDIR /app
ENV GRADLE_OPTS="-Dorg.gradle.daemon=false"

# Copy Gradle wrapper and configuration files
COPY gradle ./gradle
COPY gradlew gradlew.bat gradle.properties settings.gradle.kts build.gradle.kts ./
COPY backend/build.gradle.kts ./backend/
COPY frontend/build.gradle.kts ./frontend/

# Resolve dependencies for both modules to leverage layer caching
RUN gradle dependencies --no-daemon

############################
# Test Build stage
############################
FROM base AS build-test
# Copy all source code (including tests)
COPY backend/src ./backend/src
COPY frontend/src ./frontend/src
COPY frontend/webpack.config.d ./frontend/webpack.config.d

############################
# JRE build stage
############################
FROM eclipse-temurin:21-alpine AS jre-build

# Create a custom minimal Java runtime with only required modules
RUN apk add --no-cache binutils
RUN $JAVA_HOME/bin/jlink \
        --add-modules java.base \
        --add-modules java.xml \
        --add-modules java.naming \
        --add-modules java.management \
        --add-modules java.sql \
        --add-modules jdk.crypto.ec \
        --add-modules jdk.crypto.cryptoki \
        --add-modules java.security.jgss \
        --add-modules java.security.sasl \
        --strip-debug \
        --no-man-pages \
        --no-header-files \
        --compress=2 \
        --output /javaruntime

############################
# Test Runtime stage
############################
FROM alpine:latest

ENV JAVA_HOME=/opt/java
ENV PATH="${JAVA_HOME}/bin:${PATH}"
COPY --from=jre-build /javaruntime $JAVA_HOME

WORKDIR /app

# Install runtime dependencies needed for tests
# ImageMagick needs delegate libraries for image format support:
# - imagemagick: Core ImageMagick tools
# - libjpeg-turbo: JPEG image support (delegate library)
# - libpng: PNG image support (delegate library)
# - libwebp: WebP image support (delegate library)
# Without these delegate libraries, ImageMagick will fail with "no decode delegate" errors
RUN apk add --no-cache \
    curl \
    imagemagick \
    libjpeg-turbo \
    libpng \
    libwebp

# Copy gradle wrapper and configuration
COPY --from=build-test /app/gradle ./gradle
COPY --from=build-test /app/gradlew ./
COPY --from=build-test /app/gradle.properties ./
COPY --from=build-test /app/settings.gradle.kts ./
COPY --from=build-test /app/build.gradle.kts ./
COPY --from=build-test /app/backend/build.gradle.kts ./backend/
COPY --from=build-test /app/frontend/build.gradle.kts ./frontend/

# Copy source and test files
COPY --from=build-test /app/backend/src ./backend/src
COPY --from=build-test /app/frontend/src ./frontend/src
COPY --from=build-test /app/frontend/webpack.config.d ./frontend/webpack.config.d

# Verify ImageMagick is working
RUN magick -version && \
    magick identify -list configure | grep DELEGATES

# Run tests by default
CMD ["./gradlew", "test", "--no-daemon"]
